name: Build and Upload Theme to PocketBase (Staging)

on:
  push:
    branches:
      - dev
  workflow_dispatch:

jobs:
  build-and-upload-staging:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Clean install dependencies
        run: |
          rm -rf package-lock.json node_modules
          npm install

      - name: Build theme
        run: npm run build

      - name: Create theme manifest
        run: |
          echo '{
            "name": "${{ github.event.repository.name }}",
            "version": "dev-${{ github.sha }}",
            "built_with": "SvelteKit",
            "build_date": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'",
            "api_compatibility": "v1",
            "commit_sha": "${{ github.sha }}",
            "repository": "${{ github.repository }}",
            "branch": "dev"
          }' > build/theme-manifest.json

      - name: Create theme package
        run: |
          cd build
          zip -r "../${{ github.event.repository.name }}-dev-${{ github.sha }}.zip" .
          cd ..
          echo "ZIP_FILE=${{ github.event.repository.name }}-dev-${{ github.sha }}.zip" >> $GITHUB_ENV

      - name: Extract theme info from theme.json
        id: theme_info
        run: |
          DISPLAY_NAME=$(node -p "require('./static/theme.json').name || '${{ github.event.repository.name }}'" 2>/dev/null || echo "${{ github.event.repository.name }}")
          DESCRIPTION=$(node -p "require('./static/theme.json').description || ''" 2>/dev/null || echo "")
          DEMO_URL=$(node -p "require('./static/theme.json').demoUrl || ''" 2>/dev/null || echo "")
          FEATURES=$(node -p "JSON.stringify(require('./static/theme.json').features || [])" 2>/dev/null || echo "[]")
          TECHNOLOGIES=$(node -p "JSON.stringify(require('./static/theme.json').technologies || ['SvelteKit', 'TypeScript', 'Tailwind CSS'])" 2>/dev/null || echo '["SvelteKit", "TypeScript", "Tailwind CSS"]')
          COMPATIBILITY=$(node -p "JSON.stringify(require('./static/theme.json').compatibility || {})" 2>/dev/null || echo "{}")

          DEMO_URL="${{ vars.DEMO_URL || secrets.DEMO_URL || '$DEMO_URL' }}"

          echo "display_name=$DISPLAY_NAME [STAGING]" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "demo_url=$DEMO_URL" >> $GITHUB_OUTPUT
          echo "features=$FEATURES" >> $GITHUB_OUTPUT
          echo "technologies=$TECHNOLOGIES" >> $GITHUB_OUTPUT
          echo "compatibility=$COMPATIBILITY" >> $GITHUB_OUTPUT

          echo "âœ… Extracted theme info:"
          echo "  Display Name: $DISPLAY_NAME [STAGING]"
          echo "  Description: $DESCRIPTION"
          echo "  Demo URL: $DEMO_URL"
          echo "  Features: $FEATURES"
          echo "  Technologies: $TECHNOLOGIES"
          echo "  Compatibility: $COMPATIBILITY"

      - name: Upload theme to PocketBase (Staging)
        env:
          POCKETBASE_URL: ${{ secrets.POCKETBASE_URL }}
          POCKETBASE_EMAIL: ${{ secrets.POCKETBASE_EMAIL }}
          POCKETBASE_PASSWORD: ${{ secrets.POCKETBASE_PASSWORD }}
        run: |
          AUTH_RESPONSE=$(curl -s -X POST "$POCKETBASE_URL/api/collections/users/auth-with-password" \
            -H "Content-Type: application/json" \
            -d '{
              "identity": "'$POCKETBASE_EMAIL'",
              "password": "'$POCKETBASE_PASSWORD'"
            }')

          TOKEN=$(echo $AUTH_RESPONSE | jq -r '.token')
          USER_ID=$(echo $AUTH_RESPONSE | jq -r '.record.id')

          if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
            echo "âŒ Authentication failed"
            echo "Response: $AUTH_RESPONSE"
            exit 1
          fi

          echo "âœ… Authenticated successfully"
          echo "ğŸ†” User ID: $USER_ID"

          FEATURES_JSON='${{ steps.theme_info.outputs.features }}'
          TECHNOLOGIES_JSON='${{ steps.theme_info.outputs.technologies }}'
          COMPATIBILITY_JSON='${{ steps.theme_info.outputs.compatibility }}'
          METADATA_JSON='{"build_date":"'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'","commit_sha":"${{ github.sha }}","repository":"${{ github.repository }}","branch":"dev"}'

          echo "ğŸ” Debug JSON data:"
          echo "  Features: $FEATURES_JSON"
          echo "  Technologies: $TECHNOLOGIES_JSON"
          echo "  Compatibility: $COMPATIBILITY_JSON"
          echo "  Metadata: $METADATA_JSON"

          echo "ğŸ†• Creating new staging theme entry"
          RESPONSE=$(curl -s -X POST "$POCKETBASE_URL/api/collections/themes/records" \
            -H "Authorization: Bearer $TOKEN" \
            -F "owner=$USER_ID" \
            -F "name=${{ github.event.repository.name }}-staging-$(date +%s)" \
            -F "display_name=${{ steps.theme_info.outputs.display_name }}" \
            -F "description=${{ steps.theme_info.outputs.description }}" \
            -F "version=dev-${{ github.sha }}" \
            -F "demo_url=${{ steps.theme_info.outputs.demo_url }}" \
            -F "build_file=@$ZIP_FILE" \
            -F "features=$FEATURES_JSON" \
            -F "technologies=$TECHNOLOGIES_JSON" \
            -F "compatibility=$COMPATIBILITY_JSON" \
            -F "metadata=$METADATA_JSON" \
            -F "submission_status=staging")

          echo "ğŸ“¥ Create response:"
          echo "$RESPONSE" | jq .

          if echo "$RESPONSE" | jq -e '.id' > /dev/null; then
            THEME_ID=$(echo "$RESPONSE" | jq -r '.id')
            echo "âœ… Staging theme uploaded successfully!"
            echo "ğŸ†” Theme ID: $THEME_ID"
            echo "ğŸ“¦ Package: $ZIP_FILE"
            echo "ğŸ”— Demo: ${{ steps.theme_info.outputs.demo_url }}"
            echo "ğŸ·ï¸  Status: STAGING"
            echo "âœ¨ Features: $FEATURES_JSON"
          else
            echo "âŒ Upload failed"
            echo "ğŸ“¥ Full response:"
            echo "$RESPONSE"
            exit 1
          fi
